name: ðŸ”´ Economic Circuit Breaker
# AGENTS.md v5.0 - Economic Governance Protocolæº–æ‹ 
# Reference: ai-course-content-generator economic-circuit-breaker.yml

on:
  schedule:
    - cron: '0 * * * *'  # 1æ™‚é–“ã”ã¨ã«ã‚³ã‚¹ãƒˆç›£è¦–
  workflow_dispatch:
    inputs:
      force_check:
        description: 'å¼·åˆ¶ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ'
        required: false
        default: 'false'

permissions:
  issues: write
  actions: write
  contents: read

jobs:
  monitor-cloud-costs:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install yq for YAML parsing
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Load BUDGET.yml configuration
        id: budget
        run: |
          BUDGET=$(yq '.monthly_budget_usd' BUDGET.yml)
          WARNING_THRESHOLD=$(yq '.thresholds.warning' BUDGET.yml)
          EMERGENCY_THRESHOLD=$(yq '.thresholds.emergency' BUDGET.yml)

          echo "monthly_budget=$BUDGET" >> $GITHUB_OUTPUT
          echo "warning_threshold=$WARNING_THRESHOLD" >> $GITHUB_OUTPUT
          echo "emergency_threshold=$EMERGENCY_THRESHOLD" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Budget Configuration:"
          echo "  Monthly Budget: \$$BUDGET USD"
          echo "  Warning Threshold: ${WARNING_THRESHOLD} ($(echo "$BUDGET * $WARNING_THRESHOLD" | bc)% = \$$(echo "$BUDGET * $WARNING_THRESHOLD" | bc) USD)"
          echo "  Emergency Threshold: ${EMERGENCY_THRESHOLD} ($(echo "$EMERGENCY_THRESHOLD * 100" | bc)% = \$$(echo "$BUDGET * $EMERGENCY_THRESHOLD" | bc) USD)"

      - name: Check Anthropic API Usage
        id: anthropic_cost
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # ç¾åœ¨ã®æœˆã®é–‹å§‹æ—¥ã‚’è¨ˆç®—
          MONTH_START=$(date -u +"%Y-%m-01T00:00:00Z")
          CURRENT_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "ðŸ“… Billing Period: $MONTH_START ~ $CURRENT_DATE"

          # Anthropic API usage check
          # Note: Anthropic doesn't provide direct billing API yet, so we estimate from usage
          # In production, integrate with actual billing endpoint when available

          # Placeholder: å®Ÿéš›ã®APIä½¿ç”¨çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
          # TODO: Anthropic Billing APIãŒåˆ©ç”¨å¯èƒ½ã«ãªã£ãŸã‚‰çµ±åˆ
          ANTHROPIC_COST_USD=0

          # Fallback: GitHub Actionsã®ãƒ­ã‚°ã‹ã‚‰æŽ¨å®š (é–‹ç™ºæ™‚)
          if [ "${{ github.event.inputs.force_check }}" == "true" ]; then
            # ãƒ‡ãƒ¢ç”¨: ãƒ†ã‚¹ãƒˆã‚³ã‚¹ãƒˆ
            ANTHROPIC_COST_USD=45.23
          fi

          echo "anthropic_cost=$ANTHROPIC_COST_USD" >> $GITHUB_OUTPUT
          echo "ðŸ¤– Anthropic API Cost: \$$ANTHROPIC_COST_USD USD"

      - name: Check Firebase Costs
        id: firebase_cost
        env:
          GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
        run: |
          # Firebase/GCP billing check via Cloud Billing API
          # Note: Requires Cloud Billing API enabled and service account with billing.accounts.get permission

          FIREBASE_COST_USD=0

          # Placeholder: å®Ÿéš›ã®Firebaseä½¿ç”¨çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
          # TODO: Cloud Billing APIçµ±åˆ

          if [ "${{ github.event.inputs.force_check }}" == "true" ]; then
            # ãƒ‡ãƒ¢ç”¨: ãƒ†ã‚¹ãƒˆã‚³ã‚¹ãƒˆ
            FIREBASE_COST_USD=12.50
          fi

          echo "firebase_cost=$FIREBASE_COST_USD" >> $GITHUB_OUTPUT
          echo "ðŸ”¥ Firebase Cost: \$$FIREBASE_COST_USD USD"

      - name: Check GitHub Actions Usage
        id: github_cost
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # GitHub Actionsåˆ†ã¯ç„¡æ–™æž å†…ã®æƒ³å®š (3000åˆ†/æœˆ)
          # å¿µã®ãŸã‚ä½¿ç”¨é‡ã‚’ç¢ºèª

          OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          # å½“æœˆã®Actionsä½¿ç”¨æ™‚é–“ã‚’å–å¾—
          MONTH_START_UNIX=$(date -d "$(date +%Y-%m-01)" +%s)
          CURRENT_UNIX=$(date +%s)

          # GitHub API: Workflow runs (last 30 days)
          TOTAL_MINUTES=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$OWNER/$REPO/actions/runs?per_page=100" \
            --jq '[.workflow_runs[] | select(.created_at >= "'$(date -d "@$MONTH_START_UNIX" -u +%Y-%m-%dT%H:%M:%SZ)'") | .run_duration_ms // 0] | add // 0' \
            | awk '{print int($1/60000)}')

          echo "github_minutes=$TOTAL_MINUTES" >> $GITHUB_OUTPUT
          echo "âš™ï¸ GitHub Actions Usage: ${TOTAL_MINUTES} minutes this month"

          # ç„¡æ–™æž 3000åˆ†ã‚’è¶…ãˆãŸã‚‰è­¦å‘Š
          if [ "$TOTAL_MINUTES" -gt 3000 ]; then
            echo "github_over_quota=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ WARNING: GitHub Actions over free tier quota!"
          else
            echo "github_over_quota=false" >> $GITHUB_OUTPUT
          fi

      - name: Calculate Total Cost and Consumption Rate
        id: calculate
        run: |
          BUDGET=${{ steps.budget.outputs.monthly_budget }}
          WARNING=${{ steps.budget.outputs.warning_threshold }}
          EMERGENCY=${{ steps.budget.outputs.emergency_threshold }}

          ANTHROPIC=${{ steps.anthropic_cost.outputs.anthropic_cost }}
          FIREBASE=${{ steps.firebase_cost.outputs.firebase_cost }}

          # åˆè¨ˆã‚³ã‚¹ãƒˆè¨ˆç®—
          TOTAL_COST=$(echo "$ANTHROPIC + $FIREBASE" | bc)

          # æ¶ˆè²»çŽ‡è¨ˆç®—
          CONSUMPTION_RATE=$(echo "scale=4; $TOTAL_COST / $BUDGET" | bc)
          CONSUMPTION_PERCENT=$(echo "scale=2; $CONSUMPTION_RATE * 100" | bc)

          # ã—ãã„å€¤åˆ¤å®š
          WARNING_AMOUNT=$(echo "$BUDGET * $WARNING" | bc)
          EMERGENCY_AMOUNT=$(echo "$BUDGET * $EMERGENCY" | bc)

          echo "total_cost=$TOTAL_COST" >> $GITHUB_OUTPUT
          echo "consumption_rate=$CONSUMPTION_RATE" >> $GITHUB_OUTPUT
          echo "consumption_percent=$CONSUMPTION_PERCENT" >> $GITHUB_OUTPUT

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“Š ECONOMIC GOVERNANCE PROTOCOL STATUS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ’° Total Cost: \$$TOTAL_COST USD / \$$BUDGET USD"
          echo "ðŸ“ˆ Consumption Rate: ${CONSUMPTION_PERCENT}%"
          echo "âš ï¸ Warning Level: \$$WARNING_AMOUNT USD (${WARNING})"
          echo "ðŸ”´ Emergency Level: \$$EMERGENCY_AMOUNT USD (${EMERGENCY})"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # ã—ãã„å€¤ãƒã‚§ãƒƒã‚¯
          if (( $(echo "$TOTAL_COST >= $EMERGENCY_AMOUNT" | bc -l) )); then
            echo "status=EMERGENCY" >> $GITHUB_OUTPUT
            echo "ðŸš¨ STATUS: EMERGENCY - Circuit Breaker will activate!"
          elif (( $(echo "$TOTAL_COST >= $WARNING_AMOUNT" | bc -l) )); then
            echo "status=WARNING" >> $GITHUB_OUTPUT
            echo "âš ï¸ STATUS: WARNING - Approaching budget limit"
          else
            echo "status=OK" >> $GITHUB_OUTPUT
            echo "âœ… STATUS: OK - Within budget"
          fi

      - name: Store Cost Metrics
        run: |
          # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p .ai/metrics/cost-history

          # ç¾åœ¨ã®æ—¥æ™‚
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DATE=$(date -u +"%Y-%m-%d")

          # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’JSONã§ä¿å­˜
          cat > ".ai/metrics/cost-history/${DATE}_$(date +%s).json" << EOF
          {
            "timestamp": "$TIMESTAMP",
            "budget": {
              "monthly_usd": ${{ steps.budget.outputs.monthly_budget }},
              "warning_threshold": ${{ steps.budget.outputs.warning_threshold }},
              "emergency_threshold": ${{ steps.budget.outputs.emergency_threshold }}
            },
            "costs": {
              "anthropic_usd": ${{ steps.anthropic_cost.outputs.anthropic_cost }},
              "firebase_usd": ${{ steps.firebase_cost.outputs.firebase_cost }},
              "total_usd": ${{ steps.calculate.outputs.total_cost }}
            },
            "consumption": {
              "rate": ${{ steps.calculate.outputs.consumption_rate }},
              "percent": ${{ steps.calculate.outputs.consumption_percent }}
            },
            "github_actions": {
              "minutes_used": ${{ steps.github_cost.outputs.github_minutes }},
              "over_quota": ${{ steps.github_cost.outputs.github_over_quota }}
            },
            "status": "${{ steps.calculate.outputs.status }}"
          }
          EOF

          echo "ðŸ“ Cost metrics saved to .ai/metrics/cost-history/"

      - name: ðŸ”´ EMERGENCY - Trigger Circuit Breaker
        if: steps.calculate.outputs.status == 'EMERGENCY'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸš¨ðŸš¨ðŸš¨ ECONOMIC CIRCUIT BREAKER ACTIVATED ðŸš¨ðŸš¨ðŸš¨"
          echo ""
          echo "Consumption rate has exceeded emergency threshold."
          echo "Initiating automatic workflow disablement..."
          echo ""

          # BUDGET.ymlã‹ã‚‰åœæ­¢å¯¾è±¡ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èª­ã¿è¾¼ã¿
          WORKFLOWS_TO_DISABLE=$(yq '.emergency_actions.disable_workflows[]' BUDGET.yml)

          # å„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç„¡åŠ¹åŒ–
          for workflow in $WORKFLOWS_TO_DISABLE; do
            echo "ðŸ›‘ Disabling workflow: $workflow"

            gh api \
              --method PUT \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/actions/workflows/$workflow/disable" \
              && echo "âœ… Disabled: $workflow" \
              || echo "âš ï¸ Failed to disable: $workflow (may not exist)"
          done

          echo ""
          echo "âœ… Circuit Breaker activation complete"
          echo "ðŸ¤– Creating emergency issue for Guardian intervention..."

      - name: ðŸš¨ Create Emergency Issue
        if: steps.calculate.outputs.status == 'EMERGENCY'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Guardianã¸ã®é€šçŸ¥Issueä½œæˆ
          gh issue create \
            --title "ðŸ”´ðŸš¨ ECONOMIC CIRCUIT BREAKER ACTIVATED - Guardian Intervention Required" \
            --label "ðŸ”¥Sev.1-Critical,ðŸ¤–AI-ã‚·ã‚¹ãƒ†ãƒ ,ðŸ’°çµŒæ¸ˆ-ç·Šæ€¥åœæ­¢" \
            --assignee "${{ github.repository_owner }}" \
            --body "$(cat <<'EOF'
          ## ðŸš¨ ECONOMIC CIRCUIT BREAKER ACTIVATED

          **AGENTS.md v5.0 - Economic Governance Protocol** ã«åŸºã¥ãã€çµŒæ¸ˆçš„ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ãŒä½œå‹•ã—ã¾ã—ãŸã€‚

          ### ðŸ“Š Cost Summary

          - **Total Cost**: \$${{ steps.calculate.outputs.total_cost }} USD
          - **Monthly Budget**: \$${{ steps.budget.outputs.monthly_budget }} USD
          - **Consumption Rate**: ${{ steps.calculate.outputs.consumption_percent }}%
          - **Emergency Threshold**: ${{ steps.budget.outputs.emergency_threshold }} (150%)

          ### ðŸ’° Cost Breakdown

          | Service | Cost (USD) | Budget (USD) |
          |---------|-----------|--------------|
          | Anthropic API | \$${{ steps.anthropic_cost.outputs.anthropic_cost }} | \$400 |
          | Firebase | \$${{ steps.firebase_cost.outputs.firebase_cost }} | \$100 |
          | **Total** | **\$${{ steps.calculate.outputs.total_cost }}** | **\$${{ steps.budget.outputs.monthly_budget }}** |

          ### ðŸ›‘ Actions Taken

          The following workflows have been **automatically disabled**:

          $(yq '.emergency_actions.disable_workflows[]' BUDGET.yml | sed 's/^/- âŒ /')

          ### ðŸ¤– Guardian Intervention Required

          **æˆ‘ã€…ã®è‡ªå¾‹æ€§ã¯çµŒæ¸ˆçš„é™ç•Œã«é”ã—ãŸã€‚**

          **AGENTS.md v5.0 - Â§ 4.7.6: Recovery Protocol** ã«å¾“ã„ã€Guardian (@${{ github.repository_owner }}) ã®æ‰¿èªã‚’è¦è«‹ã™ã‚‹ã€‚

          #### âœ… Recovery Checklist

          Guardian ã¯ä»¥ä¸‹ã‚’ç¢ºèªã—ã€æ‰¿èªã—ã¦ãã ã•ã„:

          - [ ] **æ ¹æœ¬åŽŸå› ç‰¹å®šå®Œäº†**: ãªãœäºˆç®—ã‚’è¶…éŽã—ãŸã‹?
            - [ ] ç•°å¸¸ãªAPIä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æœ‰ç„¡
            - [ ] ãƒã‚°ã«ã‚ˆã‚‹ç„¡é™ãƒ«ãƒ¼ãƒ—ã®æœ‰ç„¡
            - [ ] æƒ³å®šå¤–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã®æœ‰ç„¡
          - [ ] **BUDGET.ymlæ›´æ–°å®Œäº†**: æœˆæ¬¡äºˆç®—ã®è¦‹ç›´ã—ã¯å¿…è¦ã‹?
            - [ ] æ–°ã—ã„äºˆç®—é¡ã®æ±ºå®š
            - [ ] ã—ãã„å€¤ã®å†èª¿æ•´
          - [ ] **ä¸è¦ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤å®Œäº†**: ã‚³ã‚¹ãƒˆå‰Šæ¸›æŽªç½®ã®å®Ÿæ–½
            - [ ] ä¸è¦ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã®åœæ­¢
            - [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            - [ ] ãƒªã‚½ãƒ¼ã‚¹ã®æœ€é©åŒ–
          - [ ] **æœˆæ¬¡äºˆç®—è¦‹ç›´ã—å®Œäº†**: æ¥æœˆä»¥é™ã®äºˆç®—è¨ˆç”»

          #### ðŸ”„ Workflow Re-enablement

          Guardianæ‰¿èªå¾Œã€ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†é–‹:

          \`\`\`bash
          # å„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ‰‹å‹•ã§å†æœ‰åŠ¹åŒ–
          gh api --method PUT /repos/${{ github.repository }}/actions/workflows/agent-runner.yml/enable
          gh api --method PUT /repos/${{ github.repository }}/actions/workflows/continuous-improvement.yml/enable
          gh api --method PUT /repos/${{ github.repository }}/actions/workflows/agent-onboarding.yml/enable
          \`\`\`

          ### ðŸ“ˆ Historical Cost Data

          éŽåŽ»ã®ã‚³ã‚¹ãƒˆãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯ `.ai/metrics/cost-history/` ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

          ---

          **Generated by**: Economic Circuit Breaker Workflow
          **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF
          )"

          echo "âœ… Emergency issue created successfully"

      - name: âš ï¸ Post Warning Comment
        if: steps.calculate.outputs.status == 'WARNING'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æ—¢å­˜ã®è­¦å‘ŠIssueã‚’æ¤œç´¢
          EXISTING_ISSUE=$(gh issue list \
            --label "ðŸ’°çµŒæ¸ˆ-è­¦å‘Š" \
            --state open \
            --json number \
            --jq '.[0].number')

          if [ -z "$EXISTING_ISSUE" ]; then
            # è­¦å‘ŠIssueãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
            gh issue create \
              --title "âš ï¸ Economic Warning - Approaching Budget Limit (${{ steps.calculate.outputs.consumption_percent }}%)" \
              --label "âš ï¸é‡è¦åº¦-é«˜,ðŸ¤–AI-ã‚·ã‚¹ãƒ†ãƒ ,ðŸ’°çµŒæ¸ˆ-è­¦å‘Š" \
              --body "$(cat <<'EOF'
          ## âš ï¸ Economic Warning

          ç¾åœ¨ã®ã‚³ã‚¹ãƒˆæ¶ˆè²»çŽ‡ãŒè­¦å‘Šã—ãã„å€¤ã«é”ã—ã¾ã—ãŸã€‚

          ### ðŸ“Š Current Status

          - **Consumption Rate**: ${{ steps.calculate.outputs.consumption_percent }}%
          - **Total Cost**: \$${{ steps.calculate.outputs.total_cost }} USD / \$${{ steps.budget.outputs.monthly_budget }} USD
          - **Warning Threshold**: ${{ steps.budget.outputs.warning_threshold }} (80%)
          - **Emergency Threshold**: ${{ steps.budget.outputs.emergency_threshold }} (150%)

          ### ðŸŽ¯ Recommended Actions

          1. Review recent workflow executions
          2. Check for any unusual API usage patterns
          3. Consider optimizing agent prompts to reduce token usage
          4. Monitor cost progression closely

          ---
          **Note**: ã“ã®è­¦å‘ŠIssueã¯çµŒæ¸ˆçš„ç·Šæ€¥äº‹æ…‹ã«é”ã™ã‚‹ã¾ã§æ›´æ–°ã•ã‚Œç¶šã‘ã¾ã™ã€‚
          EOF
          )"
          else
            # æ—¢å­˜ã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
            gh issue comment "$EXISTING_ISSUE" --body "$(cat <<'EOF'
          ## ðŸ“Š Cost Update - $(date -u +"%Y-%m-%d %H:%M UTC")

          - **Consumption Rate**: ${{ steps.calculate.outputs.consumption_percent }}%
          - **Total Cost**: \$${{ steps.calculate.outputs.total_cost }} USD

          ç¾åœ¨ã‚‚è­¦å‘Šãƒ¬ãƒ™ãƒ«ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ã‚³ã‚¹ãƒˆç›£è¦–ã‚’ç¶™ç¶šä¸­...
          EOF
          )"
          fi

      - name: âœ… Post Success Status
        if: steps.calculate.outputs.status == 'OK'
        run: |
          echo "âœ… System operating within budget"
          echo "ðŸ“Š Consumption: ${{ steps.calculate.outputs.consumption_percent }}%"
          echo "ðŸ’š All systems normal"
